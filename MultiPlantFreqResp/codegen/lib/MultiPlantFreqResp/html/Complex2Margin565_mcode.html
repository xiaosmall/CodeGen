<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="129,1" id="srcline1">  1</a></span><span class="line"><span class="comment">%%this one is sub function of ALS; </span></span></span>
<span class="srcline"><span class="lineno"><a href="129,2" id="srcline2">  2</a></span><span class="line"><span class="comment">%%histoy: Jul-08-2016   add one more ouput(GmNeg) in this function,chg unit to</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,3" id="srcline3">  3</a></span><span class="line"><span class="comment">%%       Sep-21-2016   Output Inf if GM is infinity; this version different from ALS folder one ;</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,4" id="srcline4">  4</a></span><span class="line"><span class="comment">%%        Nov-30-2016    set GmPos=NaN if not find;   </span></span></span>
<span class="srcline"><span class="lineno"><a href="129,5" id="srcline5">  5</a></span><span class="line"><span class="comment">%%GmPos in dB , %GmNeg in dB for codegen ;</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,6" id="srcline6">  6</a></span><span class="line"><span class="comment">%%[input]</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,7" id="srcline7">  7</a></span><span class="line"><span class="comment">%%          L-- complex number</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,8" id="srcline8">  8</a></span><span class="line"><span class="comment">%%          f-- Frequency in Hz</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,9" id="srcline9">  9</a></span><span class="line"><span class="comment">%[output:] </span></span></span>
<span class="srcline"><span class="lineno"><a href="129,10" id="srcline10"> 10</a></span><span class="line"><span class="comment">%          GmPos -- Gain margin positive in dB</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">%          GmNeg -- Gain margin negative in dB</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">%          Pm -- phase margin  in deg</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">%          Wpm -- cross over freq in rad/s;</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">% 3 type of result for Gm,Pm:(only two types of results,no infinity)</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,15" id="srcline15"> 15</a></span><span class="line"><span class="comment">%(1) not found(Nan):</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,16" id="srcline16"> 16</a></span><span class="line"><span class="comment">%                   not cross 0 dB, Pm is Nan; </span></span></span>
<span class="srcline"><span class="lineno"><a href="129,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">%                   not cross -180 deg, Gm(pos&amp; neg) is Nan;</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="129,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">%(2) infinity;-- if GmPositive is normal number,GmNegative is</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,20" id="srcline20"> 20</a></span><span class="line"><span class="comment">%(3) some number value;</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,21" id="srcline21"> 21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="129,22" id="srcline22"> 22</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">GmPos</span>,<span class="var type1" id="S3T1U4">GmNeg</span>,<span class="var type1" id="S4T1U5">Pm</span>,<span class="var type1" id="S5T1U6">Wpm</span>] = Complex2Margin(<span class="var type1" id="S6T33U9">L</span>,<span class="var type1" id="S7T9U10">f</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="129,23" id="srcline23"> 23</a></span><span class="line"><span class="mxinfo " id="T1:U7"><span class="var type1" id="S8T1U13">InfValueHack</span> = <span class="mxinfo " id="T1:U9">123454321</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,24" id="srcline24"> 24</a></span><span class="line"><span class="mxinfo " id="T1:U10"><span class="var type1" id="S2T1U17">GmPos</span> = <span class="var type1" id="S8T1U18">InfValueHack</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,25" id="srcline25"> 25</a></span><span class="line"><span class="mxinfo " id="T1:U13"><span class="var type1" id="S3T1U21">GmNeg</span> = <span class="var type1" id="S8T1U22">InfValueHack</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,26" id="srcline26"> 26</a></span><span class="line"><span class="mxinfo " id="T1:U16"><span class="var type1" id="S4T1U25">Pm</span> = <span class="var type1" id="S8T1U26">InfValueHack</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,27" id="srcline27"> 27</a></span><span class="line"><span class="mxinfo " id="T1:U19"><span class="var type1" id="S5T1U29">Wpm</span> = <span class="var type1" id="S8T1U30">InfValueHack</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,29" id="srcline29"> 29</a></span><span class="line"><span class="mxinfo " id="T1:U22"><span class="var type1" id="S9T1U33">NaNRepresent</span> =  <span class="mxinfo " id="T1:U24">999999</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,30" id="srcline30"> 30</a></span><span class="line"><span class="mxinfo " id="T9:U25"><span class="var type1" id="S10T9U37">aL</span> = <span class="mxinfo " id="T9:U27">abs(<span class="var type1" id="S6T33U40">L</span>)</span></span>;                    <span class="comment">% aL is the open loop Gain vectoe</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,31" id="srcline31"> 31</a></span><span class="line"><span class="mxinfo " id="T9:U29"><span class="var type1" id="S12T9U43">pL</span> = <span class="mxinfo " id="T9:U31"><span class="mxinfo " id="T9:U32"><span class="mxinfo " id="T9:U33">unwrap(<span class="mxinfo " id="T9:U34">angle(<span class="var type1" id="S6T33U50">L</span>)</span>)</span>*<span class="mxinfo " id="T1:U36">180</span></span>/pi</span></span>;   <span class="comment">% pL is the open loop phase in deg.</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,32" id="srcline32"> 32</a></span><span class="line"><span class="keyword">while</span> <span class="mxinfo " id="T7:U37"><span class="mxinfo " id="T1:U38"><span class="var type1" id="S12T9U57">pL</span>(<span class="mxinfo " id="T1:U40">1</span>)</span> &gt; <span class="mxinfo " id="T1:U41">90</span></span>,</span></span>
<span class="srcline"><span class="lineno"><a href="129,33" id="srcline33"> 33</a></span><span class="line">    <span class="mxinfo " id="T9:U42"><span class="var type1" id="S12T9U62">pL</span> = <span class="mxinfo " id="T9:U44"><span class="var type1" id="S12T9U64">pL</span> - <span class="mxinfo " id="T1:U46">360</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,34" id="srcline34"> 34</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">% Find indexes of all cases that to open loop phase cross the -180 deg</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,36" id="srcline36"> 36</a></span><span class="line"><span class="mxinfo " id="T9:U47"><span class="var type1" id="S16T9U68">pLm180</span> = <span class="mxinfo " id="T9:U49"><span class="var type1" id="S12T9U70">pL</span>+<span class="mxinfo " id="T1:U51">180</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,37" id="srcline37"> 37</a></span><span class="line"><span class="mxinfo " id="T9:U52"><span class="var type1" id="S17T9U74">spLm180</span> = <span class="mxinfo " id="T9:U54">sign(<span class="var type1" id="S16T9U77">pLm180</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,38" id="srcline38"> 38</a></span><span class="line"><span class="mxinfo " id="T67:U56"><span class="var type1" id="S19T67U80">ind2m180cross</span> = <span class="mxinfo " id="T67:U58">find(<span class="mxinfo " id="T72:U59"><span class="mxinfo " id="T67:U60">diff(<span class="var type1" id="S17T9U86">spLm180</span>)</span>~=<span class="mxinfo " id="T1:U62">0</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,39" id="srcline39"> 39</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="129,40" id="srcline40"> 40</a></span><span class="line"><span class="comment">% If there is no -180 degree cross the gim amrign is infinity!</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,41" id="srcline41"> 41</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T7:U63">isempty(<span class="var type1" id="S19T67U92">ind2m180cross</span>)</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="129,42" id="srcline42"> 42</a></span><span class="line">    <span class="mxinfo " id="T1:U65"><span class="var type1" id="S2T1U95">GmPos</span> = <span class="var type1" id="S9T1U96">NaNRepresent</span></span>;   <span class="comment">%%chg by sophia for c</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,43" id="srcline43"> 43</a></span><span class="line">    <span class="mxinfo " id="T1:U68"><span class="var type1" id="S3T1U99">GmNeg</span> = <span class="var type1" id="S9T1U100">NaNRepresent</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,44" id="srcline44"> 44</a></span><span class="line"><span class="comment">%     GmPos = Inf;   %%when this case need to remove GMPos and GmNeg in ctrl-cost calculation;</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,45" id="srcline45"> 45</a></span><span class="line"><span class="comment">%     GmNeg = Inf;</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,46" id="srcline46"> 46</a></span><span class="line">    <span class="comment">% Estimate the gain at -180 degree by gain vector interpolation</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,47" id="srcline47"> 47</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,48" id="srcline48"> 48</a></span><span class="line">    <span class="mxinfo " id="T67:U71"><span class="var type1" id="S23T67U104">Ga</span> = <span class="mxinfo " id="T67:U73">zeros(<span class="mxinfo " id="T1:U74">length(<span class="var type1" id="S19T67U109">ind2m180cross</span>)</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,49" id="srcline49"> 49</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S26T1U113">i</span>=<span class="mxinfo " id="T1:U77">1</span>:length(<span class="var type1" id="S19T67U118">ind2m180cross</span>),</span></span>
<span class="srcline"><span class="lineno"><a href="129,50" id="srcline50"> 50</a></span><span class="line">        <span class="mxinfo " id="T1:U79"><span class="mxinfo " id="T1:U80"><span class="var type1" id="S23T67U122">Ga</span>(<span class="var type1" id="S26T1U123">i</span>)</span> = <span class="mxinfo " id="T1:U83"><span class="mxinfo " id="T1:U84"><span class="var type1" id="S10T9U126">aL</span>(<span class="mxinfo " id="T1:U86"><span class="var type1" id="S19T67U128">ind2m180cross</span>(<span class="var type1" id="S26T1U129">i</span>)</span>)</span> + <span class="mxinfo " id="T1:U89"><span class="mxinfo " id="T1:U90">(<span class="mxinfo " id="T1:U91"><span class="mxinfo " id="T1:U92">-<span class="mxinfo " id="T1:U93">180</span></span>-<span class="mxinfo " id="T1:U94"><span class="var type1" id="S12T9U137">pL</span>(<span class="mxinfo " id="T1:U96"><span class="var type1" id="S19T67U139">ind2m180cross</span>(<span class="var type1" id="S26T1U140">i</span>)</span>)</span></span>) * <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,51" id="srcline51"> 51</a></span><span class="line">            <span class="mxinfo " id="T1:U99">diff(<span class="mxinfo " id="T38:U100"><span class="var type1" id="S10T9U144">aL</span>(<span class="mxinfo " id="T38:U102"><span class="mxinfo " id="T1:U103"><span class="var type1" id="S19T67U147">ind2m180cross</span>(<span class="var type1" id="S26T1U148">i</span>)</span>:<span class="mxinfo " id="T1:U106"><span class="mxinfo " id="T1:U107"><span class="var type1" id="S19T67U151">ind2m180cross</span>(<span class="var type1" id="S26T1U152">i</span>)</span>+1</span></span>)</span>)</span></span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,52" id="srcline52"> 52</a></span><span class="line">            /<span class="mxinfo " id="T1:U110">diff(<span class="mxinfo " id="T38:U111"><span class="var type1" id="S12T9U157">pL</span>(<span class="mxinfo " id="T38:U113"><span class="mxinfo " id="T1:U114"><span class="var type1" id="S19T67U160">ind2m180cross</span>(<span class="var type1" id="S26T1U161">i</span>)</span>:<span class="mxinfo " id="T1:U117"><span class="mxinfo " id="T1:U118"><span class="var type1" id="S19T67U164">ind2m180cross</span>(<span class="var type1" id="S26T1U165">i</span>)</span>+1</span></span>)</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,53" id="srcline53"> 53</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,54" id="srcline54"> 54</a></span><span class="line">    <span class="comment">% Search for gains that are the closest to 0 dB</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,55" id="srcline55"> 55</a></span><span class="line">    <span class="mxinfo " id="T74:U121"><span class="var type1" id="S27T74U169">Ind2MinGm</span> = <span class="mxinfo " id="T74:U123">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,56" id="srcline56"> 56</a></span><span class="line">    <span class="mxinfo " id="T67:U124"><span class="var type1" id="S28T67U174">Gdb</span> = <span class="mxinfo " id="T9:U126"><span class="mxinfo " id="T1:U127">20</span>*<span class="mxinfo " id="T9:U128">log10(<span class="var type1" id="S23T67U179">Ga</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,57" id="srcline57"> 57</a></span><span class="line">    <span class="mxinfo " id="T67:U130"><span class="var type1" id="S30T67U182">ind2pos</span> = <span class="mxinfo " id="T67:U132">find(<span class="mxinfo " id="T72:U133"><span class="var type1" id="S28T67U186">Gdb</span>&gt;=<span class="mxinfo " id="T1:U135">0</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,58" id="srcline58"> 58</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T7:U136">~<span class="mxinfo " id="T7:U137">isempty(<span class="var type1" id="S30T67U193">ind2pos</span>)</span></span>,</span></span>
<span class="srcline"><span class="lineno"><a href="129,59" id="srcline59"> 59</a></span><span class="line">        [<span class="mxinfo " id="T1:U139">~</span>,<span class="var type1" id="S31T1U198">TempIndex</span>] = min(<span class="mxinfo " id="T67:U141"><span class="var type1" id="S28T67U202">Gdb</span>(<span class="var type1" id="S30T67U203">ind2pos</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="129,60" id="srcline60"> 60</a></span><span class="line">        <span class="mxinfo " id="T46:U144"><span class="var type1" id="S27T46U206">Ind2MinGm</span> = <span class="mxinfo " id="T1:U146"><span class="var type1" id="S30T67U208">ind2pos</span>(<span class="var type1" id="S31T1U209">TempIndex</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,61" id="srcline61"> 61</a></span><span class="line">        <span class="mxinfo " id="T46:U149"><span class="var type1" id="S3T46U212">GmNeg</span> =  <span class="mxinfo " id="T46:U151">1/<span class="mxinfo " id="T46:U152"><span class="var type1" id="S23T67U216">Ga</span>(<span class="var type1" id="S27T46U217">Ind2MinGm</span>)</span></span></span>;<span class="comment">%%chg by sophia to fix c code</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,62" id="srcline62"> 62</a></span><span class="line">        <span class="mxinfo " id="T46:U155"><span class="var type1" id="S3T46U220">GmNeg</span> = <span class="mxinfo " id="T46:U157"><span class="mxinfo " id="T1:U158">20</span>*<span class="mxinfo " id="T46:U159">log10(<span class="var type1" id="S3T46U225">GmNeg</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,63" id="srcline63"> 63</a></span><span class="line">        <span class="mxinfo " id="T1:U161"><span class="var type1" id="S3T1U228">GmNeg</span> = <span class="mxinfo " id="T1:U163"><span class="var type1" id="S3T46U230">GmNeg</span>(<span class="mxinfo " id="T1:U165">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,64" id="srcline64"> 64</a></span><span class="line">        <span class="comment">%%no need else,  GmNeg is infinit(123454321);the is conditional stable ,</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,65" id="srcline65"> 65</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,66" id="srcline66"> 66</a></span><span class="line">    <span class="comment">% For the conditional stable case look for negative gain margin as well</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,67" id="srcline67"> 67</a></span><span class="line">    <span class="mxinfo " id="T67:U166"><span class="var type1" id="S33T67U234">ind2neg</span> = <span class="mxinfo " id="T67:U168">find(<span class="mxinfo " id="T72:U169"><span class="var type1" id="S28T67U238">Gdb</span>&lt;<span class="mxinfo " id="T1:U171">0</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,68" id="srcline68"> 68</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T7:U172">~<span class="mxinfo " id="T7:U173">isempty(<span class="var type1" id="S33T67U245">ind2neg</span>)</span></span>,</span></span>
<span class="srcline"><span class="lineno"><a href="129,69" id="srcline69"> 69</a></span><span class="line">        [<span class="mxinfo " id="T1:U175">~</span>,<span class="var type1" id="S31T1U250">TempIndex</span>] = max(<span class="mxinfo " id="T67:U177"><span class="var type1" id="S28T67U254">Gdb</span>(<span class="var type1" id="S33T67U255">ind2neg</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="129,70" id="srcline70"> 70</a></span><span class="line">        <span class="comment">%Ind2MinGm = [Ind2MinGm ind2neg(TempIndex)];</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,71" id="srcline71"> 71</a></span><span class="line">        <span class="mxinfo " id="T1:U180"><span class="var type1" id="S2T1U258">GmPos</span> = <span class="mxinfo " id="T1:U182"><span class="mxinfo " id="T1:U183">1</span>/<span class="mxinfo " id="T1:U184"><span class="var type1" id="S23T67U262">Ga</span>(<span class="mxinfo " id="T1:U186"><span class="var type1" id="S33T67U264">ind2neg</span>(<span class="var type1" id="S31T1U265">TempIndex</span>)</span>)</span></span></span>;<span class="comment">%%chg by sophia to fix c code</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,72" id="srcline72"> 72</a></span><span class="line">        <span class="mxinfo " id="T1:U189"><span class="var type1" id="S2T1U268">GmPos</span> = <span class="mxinfo " id="T1:U191"><span class="mxinfo " id="T1:U192">20</span>*<span class="mxinfo " id="T1:U193">log10(<span class="var type1" id="S2T1U273">GmPos</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,73" id="srcline73"> 73</a></span><span class="line">        <span class="mxinfo " id="T1:U195"><span class="var type1" id="S2T1U276">GmPos</span> =<span class="var type1" id="S2T1U278">GmPos</span>(1)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,74" id="srcline74"> 74</a></span><span class="line">     <span class="keyword">else</span> <span class="comment">%2016-11-30; need to release;</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,75" id="srcline75"> 75</a></span><span class="line">         <span class="mxinfo " id="T1:U198"><span class="var type1" id="S2T1U283">GmPos</span> = <span class="var type1" id="S9T1U284">NaNRepresent</span></span>; <span class="comment">%2016-11-30;</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,76" id="srcline76"> 76</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,77" id="srcline77"> 77</a></span><span class="line">    <span class="comment">% The gain margin is one over the gain!</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,78" id="srcline78"> 78</a></span><span class="line">   <span class="comment">% Gm = 1./Ga(Ind2MinGm);</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,79" id="srcline79"> 79</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,80" id="srcline80"> 80</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="129,81" id="srcline81"> 81</a></span><span class="line"><span class="comment">% Find indexes of all cases that to open loop gain cross the 0 dB and the </span></span></span>
<span class="srcline"><span class="lineno"><a href="129,82" id="srcline82"> 82</a></span><span class="line"><span class="comment">% gain curve has negative slope.</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,83" id="srcline83"> 83</a></span><span class="line"><span class="mxinfo " id="T9:U201"><span class="var type1" id="S35T9U287">saLm1</span> = <span class="mxinfo " id="T9:U203">sign(<span class="mxinfo " id="T9:U204"><span class="var type1" id="S10T9U291">aL</span>-<span class="mxinfo " id="T1:U206">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,84" id="srcline84"> 84</a></span><span class="line"><span class="mxinfo " id="T67:U207"><span class="var type1" id="S36T67U295">ind2cross</span> = <span class="mxinfo " id="T67:U209">find(<span class="mxinfo " id="T72:U210"><span class="mxinfo " id="T67:U211">diff(<span class="var type1" id="S35T9U301">saLm1</span>)</span>&lt;<span class="mxinfo " id="T1:U213">0</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,85" id="srcline85"> 85</a></span><span class="line"><span class="comment">% If there is no 0 dB crossing the phase margin can't be measured!</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,86" id="srcline86"> 86</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T7:U214">isempty(<span class="var type1" id="S36T67U307">ind2cross</span>)</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="129,87" id="srcline87"> 87</a></span><span class="line">    <span class="mxinfo " id="T1:U216"><span class="var type1" id="S4T1U310">Pm</span> = <span class="var type1" id="S9T1U311">NaNRepresent</span></span>;<span class="comment">%2016-0927</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,88" id="srcline88"> 88</a></span><span class="line">    <span class="mxinfo " id="T1:U219"><span class="var type1" id="S5T1U314">Wpm</span> =<span class="var type1" id="S9T1U315">NaNRepresent</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,89" id="srcline89"> 89</a></span><span class="line">    <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,90" id="srcline90"> 90</a></span><span class="line">    <span class="comment">% In case there is only one crossing: calculate the phase at the </span></span></span>
<span class="srcline"><span class="lineno"><a href="129,91" id="srcline91"> 91</a></span><span class="line">    <span class="comment">% crossing point by an interpoltation</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,92" id="srcline92"> 92</a></span><span class="line"><span class="keyword">elseif</span> <span class="mxinfo " id="T7:U222"><span class="mxinfo " id="T1:U223">length(<span class="var type1" id="S36T67U321">ind2cross</span>)</span> == <span class="mxinfo " id="T1:U225">1</span></span>,    </span></span>
<span class="srcline"><span class="lineno"><a href="129,93" id="srcline93"> 93</a></span><span class="line">    <span class="mxinfo " id="T1:U226"><span class="var type1" id="S37T1U325">Ph</span> = <span class="mxinfo " id="T1:U228"><span class="mxinfo " id="T1:U229"><span class="var type1" id="S12T9U328">pL</span>(<span class="mxinfo " id="T1:U231"><span class="var type1" id="S36T67U330">ind2cross</span>(<span class="mxinfo " id="T1:U233">end</span>)</span>)</span> + <span class="mxinfo " id="T1:U234"><span class="mxinfo " id="T1:U235">(<span class="mxinfo " id="T1:U236"><span class="mxinfo " id="T1:U237">1</span>-<span class="mxinfo " id="T1:U238"><span class="var type1" id="S10T9U339">aL</span>(<span class="mxinfo " id="T1:U240"><span class="var type1" id="S36T67U341">ind2cross</span>(<span class="mxinfo " id="T1:U242">end</span>)</span>)</span></span>) * <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,94" id="srcline94"> 94</a></span><span class="line">        <span class="mxinfo " id="T1:U243">diff(<span class="mxinfo " id="T38:U244"><span class="var type1" id="S12T9U347">pL</span>(<span class="mxinfo " id="T38:U246"><span class="mxinfo " id="T1:U247"><span class="var type1" id="S36T67U350">ind2cross</span>(<span class="mxinfo " id="T1:U249">end</span>)</span>:<span class="mxinfo " id="T1:U250"><span class="mxinfo " id="T1:U251"><span class="var type1" id="S36T67U355">ind2cross</span>(<span class="mxinfo " id="T1:U253">end</span>)</span>+1</span></span>)</span>)</span></span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,95" id="srcline95"> 95</a></span><span class="line">        /<span class="mxinfo " id="T1:U254">diff(<span class="mxinfo " id="T38:U255"><span class="var type1" id="S10T9U362">aL</span>(<span class="mxinfo " id="T38:U257"><span class="mxinfo " id="T1:U258"><span class="var type1" id="S36T67U365">ind2cross</span>(<span class="mxinfo " id="T1:U260">end</span>)</span>:<span class="mxinfo " id="T1:U261"><span class="mxinfo " id="T1:U262"><span class="var type1" id="S36T67U370">ind2cross</span>(<span class="mxinfo " id="T1:U264">end</span>)</span>+1</span></span>)</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,96" id="srcline96"> 96</a></span><span class="line">    <span class="mxinfo " id="T1:U265"><span class="var type1" id="S5T1U376">Wpm</span> = <span class="mxinfo " id="T1:U267"><span class="mxinfo " id="T1:U268"><span class="mxinfo " id="T1:U269">interp1(<span class="mxinfo " id="T38:U270"><span class="var type1" id="S10T9U382">aL</span>(<span class="mxinfo " id="T38:U272"><span class="mxinfo " id="T1:U273"><span class="var type1" id="S36T67U385">ind2cross</span>(<span class="mxinfo " id="T1:U275">end</span>)</span>:<span class="mxinfo " id="T1:U276"><span class="mxinfo " id="T1:U277"><span class="var type1" id="S36T67U390">ind2cross</span>(<span class="mxinfo " id="T1:U279">end</span>)</span>+1</span></span>)</span>,<span class="mxinfo " id="T38:U280"><span class="var type1" id="S7T9U395">f</span>(<span class="mxinfo " id="T38:U282"><span class="mxinfo " id="T1:U283"><span class="var type1" id="S36T67U398">ind2cross</span>(<span class="mxinfo " id="T1:U285">end</span>)</span>:<span class="mxinfo " id="T1:U286"><span class="mxinfo " id="T1:U287"><span class="var type1" id="S36T67U403">ind2cross</span>(<span class="mxinfo " id="T1:U289">end</span>)</span>+1</span></span>)</span>,<span class="mxinfo " id="T1:U290">1</span>)</span>*<span class="mxinfo " id="T1:U291">2</span></span>*<span class="mxinfo " id="T1:U292">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,97" id="srcline97"> 97</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="129,98" id="srcline98"> 98</a></span><span class="line">    <span class="comment">% In case there are multiply 0 dB crossing, we need to check the range </span></span></span>
<span class="srcline"><span class="lineno"><a href="129,99" id="srcline99"> 99</a></span><span class="line">    <span class="comment">% of the phases at the crossing points in order to determine the stability.</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,100" id="srcline100">100</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,101" id="srcline101">101</a></span><span class="line">    <span class="comment">% Find the indexes of all the cases that the phase is higher than -180 degree</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,102" id="srcline102">102</a></span><span class="line">    <span class="comment">% at the 0 dB crossing points.</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,103" id="srcline103">103</a></span><span class="line">    <span class="mxinfo " id="T67:U293"><span class="var type1" id="S30T67U414">ind2pos</span> = <span class="mxinfo " id="T67:U295">find(<span class="mxinfo " id="T72:U296"><span class="mxinfo " id="T67:U297"><span class="var type1" id="S12T9U419">pL</span>(<span class="var type1" id="S36T67U420">ind2cross</span>)</span>&gt;=<span class="mxinfo " id="T1:U300">-<span class="mxinfo " id="T1:U301">180</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,104" id="srcline104">104</a></span><span class="line">    <span class="comment">% In case that there is no crossing at phase higher than -180 degree, </span></span></span>
<span class="srcline"><span class="lineno"><a href="129,105" id="srcline105">105</a></span><span class="line">    <span class="comment">% the phase margin is calculated by the 1st 0 dB crossing point</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,106" id="srcline106">106</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T7:U302">isempty(<span class="var type1" id="S30T67U427">ind2pos</span>)</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="129,107" id="srcline107">107</a></span><span class="line">        <span class="mxinfo " id="T1:U304"><span class="var type1" id="S37T1U430">Ph</span> = <span class="mxinfo " id="T1:U306"><span class="mxinfo " id="T1:U307"><span class="var type1" id="S12T9U433">pL</span>(<span class="mxinfo " id="T1:U309"><span class="var type1" id="S36T67U435">ind2cross</span>(<span class="mxinfo " id="T1:U311">1</span>)</span>)</span> + <span class="mxinfo " id="T1:U312"><span class="mxinfo " id="T1:U313">(<span class="mxinfo " id="T1:U314"><span class="mxinfo " id="T1:U315">1</span>-<span class="mxinfo " id="T1:U316"><span class="var type1" id="S10T9U443">aL</span>(<span class="mxinfo " id="T1:U318"><span class="var type1" id="S36T67U445">ind2cross</span>(<span class="mxinfo " id="T1:U320">1</span>)</span>)</span></span>) * <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,108" id="srcline108">108</a></span><span class="line">            <span class="mxinfo " id="T1:U321">diff(<span class="mxinfo " id="T38:U322"><span class="var type1" id="S12T9U450">pL</span>(<span class="mxinfo " id="T38:U324"><span class="mxinfo " id="T1:U325"><span class="var type1" id="S36T67U453">ind2cross</span>(<span class="mxinfo " id="T1:U327">1</span>)</span>:<span class="mxinfo " id="T1:U328"><span class="mxinfo " id="T1:U329"><span class="var type1" id="S36T67U457">ind2cross</span>(<span class="mxinfo " id="T1:U331">1</span>)</span>+1</span></span>)</span>)</span></span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,109" id="srcline109">109</a></span><span class="line">            /<span class="mxinfo " id="T1:U332">diff(<span class="mxinfo " id="T38:U333"><span class="var type1" id="S10T9U463">aL</span>(<span class="mxinfo " id="T38:U335"><span class="mxinfo " id="T1:U336"><span class="var type1" id="S36T67U466">ind2cross</span>(<span class="mxinfo " id="T1:U338">1</span>)</span>:<span class="mxinfo " id="T1:U339"><span class="mxinfo " id="T1:U340"><span class="var type1" id="S36T67U470">ind2cross</span>(<span class="mxinfo " id="T1:U342">1</span>)</span>+1</span></span>)</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,110" id="srcline110">110</a></span><span class="line">        <span class="mxinfo " id="T1:U343"><span class="var type1" id="S5T1U475">Wpm</span> = <span class="mxinfo " id="T1:U345"><span class="mxinfo " id="T1:U346"><span class="mxinfo " id="T1:U347">interp1(<span class="mxinfo " id="T38:U348"><span class="var type1" id="S10T9U481">aL</span>(<span class="mxinfo " id="T38:U350"><span class="mxinfo " id="T1:U351"><span class="var type1" id="S36T67U484">ind2cross</span>(<span class="mxinfo " id="T1:U353">1</span>)</span>:<span class="mxinfo " id="T1:U354"><span class="mxinfo " id="T1:U355"><span class="var type1" id="S36T67U488">ind2cross</span>(<span class="mxinfo " id="T1:U357">1</span>)</span>+1</span></span>)</span>,<span class="mxinfo " id="T38:U358"><span class="var type1" id="S7T9U492">f</span>(<span class="mxinfo " id="T38:U360"><span class="mxinfo " id="T1:U361"><span class="var type1" id="S36T67U495">ind2cross</span>(<span class="mxinfo " id="T1:U363">1</span>)</span>:<span class="mxinfo " id="T1:U364"><span class="mxinfo " id="T1:U365"><span class="var type1" id="S36T67U499">ind2cross</span>(<span class="mxinfo " id="T1:U367">1</span>)</span>+1</span></span>)</span>,<span class="mxinfo " id="T1:U368">1</span>)</span>*<span class="mxinfo " id="T1:U369">2</span></span>*<span class="mxinfo " id="T1:U370">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,111" id="srcline111">111</a></span><span class="line">        <span class="comment">% If there is 0 dB crossing with phase higher than -180 degree.</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,112" id="srcline112">112</a></span><span class="line">        <span class="comment">% We need to look also if there are 0 dB crossing with phase lower than</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,113" id="srcline113">113</a></span><span class="line">        <span class="comment">% -180 degree</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,114" id="srcline114">114</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,115" id="srcline115">115</a></span><span class="line">        <span class="mxinfo " id="T67:U371"><span class="var type1" id="S33T67U509">ind2neg</span> = <span class="mxinfo " id="T67:U373">find(<span class="mxinfo " id="T72:U374"><span class="mxinfo " id="T67:U375"><span class="var type1" id="S12T9U514">pL</span>(<span class="var type1" id="S36T67U515">ind2cross</span>)</span>&lt;<span class="mxinfo " id="T1:U378">-<span class="mxinfo " id="T1:U379">180</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,116" id="srcline116">116</a></span><span class="line">        <span class="comment">% No crossing at phase lower than -180 degree, the phase margin is</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,117" id="srcline117">117</a></span><span class="line">        <span class="comment">% calculated by the last 0 dB crossing point</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,118" id="srcline118">118</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T7:U380">isempty(<span class="var type1" id="S33T67U522">ind2neg</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,119" id="srcline119">119</a></span><span class="line">            <span class="mxinfo " id="T1:U382"><span class="var type1" id="S37T1U525">Ph</span> = <span class="mxinfo " id="T1:U384"><span class="mxinfo " id="T1:U385"><span class="var type1" id="S12T9U528">pL</span>(<span class="mxinfo " id="T1:U387"><span class="var type1" id="S36T67U530">ind2cross</span>(<span class="mxinfo " id="T1:U389">end</span>)</span>)</span> + <span class="mxinfo " id="T1:U390"><span class="mxinfo " id="T1:U391">(<span class="mxinfo " id="T1:U392"><span class="mxinfo " id="T1:U393">1</span>-<span class="mxinfo " id="T1:U394"><span class="var type1" id="S10T9U539">aL</span>(<span class="mxinfo " id="T1:U396"><span class="var type1" id="S36T67U541">ind2cross</span>(<span class="mxinfo " id="T1:U398">end</span>)</span>)</span></span>) * <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,120" id="srcline120">120</a></span><span class="line">                <span class="mxinfo " id="T1:U399">diff(<span class="mxinfo " id="T38:U400"><span class="var type1" id="S12T9U547">pL</span>(<span class="mxinfo " id="T38:U402"><span class="mxinfo " id="T1:U403"><span class="var type1" id="S36T67U550">ind2cross</span>(<span class="mxinfo " id="T1:U405">end</span>)</span>:<span class="mxinfo " id="T1:U406"><span class="mxinfo " id="T1:U407"><span class="var type1" id="S36T67U555">ind2cross</span>(<span class="mxinfo " id="T1:U409">end</span>)</span>+1</span></span>)</span>)</span></span><span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,121" id="srcline121">121</a></span><span class="line">                /<span class="mxinfo " id="T1:U410">diff(<span class="mxinfo " id="T38:U411"><span class="var type1" id="S10T9U562">aL</span>(<span class="mxinfo " id="T38:U413"><span class="mxinfo " id="T1:U414"><span class="var type1" id="S36T67U565">ind2cross</span>(<span class="mxinfo " id="T1:U416">end</span>)</span>:<span class="mxinfo " id="T1:U417"><span class="mxinfo " id="T1:U418"><span class="var type1" id="S36T67U570">ind2cross</span>(<span class="mxinfo " id="T1:U420">end</span>)</span>+1</span></span>)</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,122" id="srcline122">122</a></span><span class="line">            <span class="mxinfo " id="T1:U421"><span class="var type1" id="S5T1U576">Wpm</span> = <span class="mxinfo " id="T1:U423"><span class="mxinfo " id="T1:U424"><span class="mxinfo " id="T1:U425">interp1(<span class="mxinfo " id="T38:U426"><span class="var type1" id="S10T9U582">aL</span>(<span class="mxinfo " id="T38:U428"><span class="mxinfo " id="T1:U429"><span class="var type1" id="S36T67U585">ind2cross</span>(<span class="mxinfo " id="T1:U431">end</span>)</span>:<span class="mxinfo " id="T1:U432"><span class="mxinfo " id="T1:U433"><span class="var type1" id="S36T67U590">ind2cross</span>(<span class="mxinfo " id="T1:U435">end</span>)</span>+1</span></span>)</span>,<span class="mxinfo " id="T38:U436"><span class="var type1" id="S7T9U595">f</span>(<span class="mxinfo " id="T38:U438"><span class="mxinfo " id="T1:U439"><span class="var type1" id="S36T67U598">ind2cross</span>(<span class="mxinfo " id="T1:U441">end</span>)</span>:<span class="mxinfo " id="T1:U442"><span class="mxinfo " id="T1:U443"><span class="var type1" id="S36T67U603">ind2cross</span>(<span class="mxinfo " id="T1:U445">end</span>)</span>+1</span></span>)</span>,<span class="mxinfo " id="T1:U446">1</span>)</span>*<span class="mxinfo " id="T1:U447">2</span></span>*<span class="mxinfo " id="T1:U448">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,123" id="srcline123">123</a></span><span class="line">            <span class="comment">% There are 0 dB crossing at phase higher &amp; lower than -180 degree,</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,124" id="srcline124">124</a></span><span class="line">            <span class="comment">% the stability is determined by the phase of the inetrmidate</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,125" id="srcline125">125</a></span><span class="line">            <span class="comment">% crossing point.</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,126" id="srcline126">126</a></span><span class="line">            <span class="comment">% At this point the gain slop is positive at the 0 dB crossing</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,127" id="srcline127">127</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,128" id="srcline128">128</a></span><span class="line">            <span class="mxinfo " id="T40:U449"><span class="var type1" id="S26T40U614">i</span> = <span class="mxinfo " id="T40:U451">ones(<span class="mxinfo " id="T1:U452">3</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,129" id="srcline129">129</a></span><span class="line">            <span class="mxinfo " id="T40:U453"><span class="var type1" id="S41T40U621">Phv</span> = <span class="mxinfo " id="T40:U455">ones(<span class="mxinfo " id="T1:U456">3</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,130" id="srcline130">130</a></span><span class="line">            <span class="comment">% Closet point to 180 degree from the higher range </span></span></span>
<span class="srcline"><span class="lineno"><a href="129,131" id="srcline131">131</a></span><span class="line">            [<span class="mxinfo " id="T1:U457">~</span>,<span class="var type1" id="S42T1U630">ind2min</span>] = min(<span class="mxinfo " id="T67:U459"><span class="var type1" id="S12T9U634">pL</span>(<span class="mxinfo " id="T67:U461"><span class="var type1" id="S36T67U636">ind2cross</span>(<span class="var type1" id="S30T67U637">ind2pos</span>)</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="129,132" id="srcline132">132</a></span><span class="line">             <span class="comment">% Closet point to 180 degree from the lower range</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,133" id="srcline133">133</a></span><span class="line">            [<span class="mxinfo " id="T1:U464">~</span>,<span class="var type1" id="S43T1U642">ind2max</span>] = max(<span class="mxinfo " id="T67:U466"><span class="var type1" id="S12T9U646">pL</span>(<span class="mxinfo " id="T67:U468"><span class="var type1" id="S36T67U648">ind2cross</span>(<span class="var type1" id="S33T67U649">ind2neg</span>)</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="129,134" id="srcline134">134</a></span><span class="line">            <span class="comment">% Indexes calculation</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,135" id="srcline135">135</a></span><span class="line">            <span class="mxinfo " id="T1:U471"><span class="mxinfo " id="T1:U472"><span class="var type1" id="S26T40U653">i</span>(<span class="mxinfo " id="T8:U474">1</span>)</span> = <span class="mxinfo " id="T1:U475"><span class="var type1" id="S36T67U656">ind2cross</span>(<span class="mxinfo " id="T1:U477"><span class="var type1" id="S30T67U658">ind2pos</span>(<span class="var type1" id="S42T1U659">ind2min</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,136" id="srcline136">136</a></span><span class="line">            <span class="mxinfo " id="T1:U480"><span class="mxinfo " id="T1:U481"><span class="var type1" id="S26T40U663">i</span>(<span class="mxinfo " id="T8:U483">2</span>)</span> = <span class="mxinfo " id="T1:U484"><span class="var type1" id="S36T67U666">ind2cross</span>(<span class="mxinfo " id="T1:U486"><span class="var type1" id="S33T67U668">ind2neg</span>(<span class="var type1" id="S43T1U669">ind2max</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,137" id="srcline137">137</a></span><span class="line">            <span class="comment">% Intermidate crossing point with positive slope</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,138" id="srcline138">138</a></span><span class="line">            <span class="mxinfo " id="T67:U489"><span class="var type1" id="S44T67U672">ind2cross_p</span> = <span class="mxinfo " id="T67:U491">find(<span class="mxinfo " id="T72:U492"><span class="mxinfo " id="T67:U493">diff(<span class="mxinfo " id="T67:U494"><span class="var type1" id="S35T9U679">saLm1</span>(<span class="mxinfo " id="T91:U496"><span class="mxinfo " id="T1:U497"><span class="var type1" id="S26T40U682">i</span>(<span class="mxinfo " id="T8:U499">1</span>)</span>:<span class="mxinfo " id="T1:U500"><span class="var type1" id="S26T40U685">i</span>(<span class="mxinfo " id="T8:U502">2</span>)</span></span> )</span>)</span>&gt;<span class="mxinfo " id="T1:U503">0</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,139" id="srcline139">139</a></span><span class="line">            <span class="mxinfo " id="T1:U504"><span class="mxinfo " id="T1:U505"><span class="var type1" id="S26T40U691">i</span>(<span class="mxinfo " id="T8:U507">3</span>)</span> = <span class="mxinfo " id="T67:U508"><span class="mxinfo " id="T67:U509"><span class="mxinfo " id="T1:U510"><span class="var type1" id="S26T40U696">i</span>(<span class="mxinfo " id="T8:U512">1</span>)</span>+<span class="var type1" id="S44T67U698">ind2cross_p</span></span>-<span class="mxinfo " id="T1:U514">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,140" id="srcline140">140</a></span><span class="line">            <span class="comment">% In case the phase is lower than -180 degree at the positive</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,141" id="srcline141">141</a></span><span class="line">            <span class="comment">% slope ccrossing -&gt; No stable</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,142" id="srcline142">142</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo " id="T7:U515"><span class="mxinfo " id="T1:U516"><span class="var type1" id="S12T9U704">pL</span>(<span class="mxinfo " id="T1:U518"><span class="var type1" id="S26T40U706">i</span>(<span class="mxinfo " id="T8:U520">3</span>)</span>)</span> &gt; <span class="mxinfo " id="T1:U521">-<span class="mxinfo " id="T1:U522">180</span></span></span>,</span></span>
<span class="srcline"><span class="lineno"><a href="129,143" id="srcline143">143</a></span><span class="line">                <span class="mxinfo " id="T1:U523"><span class="var type1" id="S45T1U712">Stability</span> = <span class="mxinfo " id="T1:U525">-<span class="mxinfo " id="T1:U526">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,144" id="srcline144">144</a></span><span class="line">            <span class="comment">% In case the phase is higher than -180 degree at the positive</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,145" id="srcline145">145</a></span><span class="line">            <span class="comment">% slope crossing -&gt; Stable</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,146" id="srcline146">146</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,147" id="srcline147">147</a></span><span class="line">                <span class="mxinfo " id="T1:U527"><span class="var type1" id="S45T1U718">Stability</span> = <span class="mxinfo " id="T1:U529">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,148" id="srcline148">148</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,149" id="srcline149">149</a></span><span class="line">            <span class="comment">% Calculate the phase at the three critical points</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,150" id="srcline150">150</a></span><span class="line">            <span class="mxinfo " id="T1:U530"><span class="mxinfo " id="T1:U531"><span class="var type1" id="S41T40U723">Phv</span>(<span class="mxinfo " id="T8:U533">1</span>)</span> = <span class="mxinfo " id="T1:U534"><span class="mxinfo " id="T1:U535"><span class="var type1" id="S12T9U727">pL</span>(<span class="mxinfo " id="T1:U537"><span class="var type1" id="S26T40U729">i</span>(<span class="mxinfo " id="T8:U539">1</span>)</span>)</span>+<span class="mxinfo " id="T1:U540"><span class="mxinfo " id="T1:U541">(<span class="mxinfo " id="T1:U542"><span class="mxinfo " id="T1:U543">1</span>-<span class="mxinfo " id="T1:U544"><span class="var type1" id="S10T9U737">aL</span>(<span class="mxinfo " id="T1:U546"><span class="var type1" id="S26T40U739">i</span>(<span class="mxinfo " id="T8:U548">1</span>)</span>)</span></span>)*<span class="mxinfo " id="T1:U549">diff(<span class="mxinfo " id="T38:U550"><span class="var type1" id="S12T9U744">pL</span>(<span class="mxinfo " id="T38:U552"><span class="mxinfo " id="T1:U553"><span class="var type1" id="S26T40U747">i</span>(<span class="mxinfo " id="T8:U555">1</span>)</span>:<span class="mxinfo " id="T1:U556"><span class="var type1" id="S26T40U751">i</span>(1)+1</span></span>)</span>)</span></span>/<span class="mxinfo " id="T1:U558">diff(<span class="mxinfo " id="T38:U559"><span class="var type1" id="S10T9U757">aL</span>(<span class="mxinfo " id="T38:U561"><span class="mxinfo " id="T1:U562"><span class="var type1" id="S26T40U760">i</span>(<span class="mxinfo " id="T8:U564">1</span>)</span>:<span class="mxinfo " id="T1:U565"><span class="var type1" id="S26T40U764">i</span>(1)+1</span></span>)</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,151" id="srcline151">151</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="129,152" id="srcline152">152</a></span><span class="line">            <span class="mxinfo " id="T1:U567"><span class="mxinfo " id="T1:U568"><span class="var type1" id="S41T40U770">Phv</span>(<span class="mxinfo " id="T8:U570">2</span>)</span> = <span class="mxinfo " id="T1:U571"><span class="mxinfo " id="T1:U572"><span class="var type1" id="S12T9U774">pL</span>(<span class="mxinfo " id="T1:U574"><span class="var type1" id="S26T40U776">i</span>(<span class="mxinfo " id="T8:U576">2</span>)</span>)</span>+<span class="mxinfo " id="T1:U577"><span class="mxinfo " id="T1:U578">(<span class="mxinfo " id="T1:U579"><span class="mxinfo " id="T1:U580">1</span>-<span class="mxinfo " id="T1:U581"><span class="var type1" id="S10T9U784">aL</span>(<span class="mxinfo " id="T1:U583"><span class="var type1" id="S26T40U786">i</span>(<span class="mxinfo " id="T8:U585">2</span>)</span>)</span></span>)*<span class="mxinfo " id="T1:U586">diff(<span class="mxinfo " id="T38:U587"><span class="var type1" id="S12T9U791">pL</span>(<span class="mxinfo " id="T38:U589"><span class="mxinfo " id="T1:U590"><span class="var type1" id="S26T40U794">i</span>(<span class="mxinfo " id="T8:U592">2</span>)</span>:<span class="mxinfo " id="T1:U593"><span class="var type1" id="S26T40U798">i</span>(2)+1</span></span>)</span>)</span></span>/<span class="mxinfo " id="T1:U595">diff(<span class="mxinfo " id="T38:U596"><span class="var type1" id="S10T9U804">aL</span>(<span class="mxinfo " id="T38:U598"><span class="mxinfo " id="T1:U599"><span class="var type1" id="S26T40U807">i</span>(<span class="mxinfo " id="T8:U601">2</span>)</span>:<span class="mxinfo " id="T1:U602"><span class="var type1" id="S26T40U811">i</span>(2)+1</span></span>)</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,153" id="srcline153">153</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="129,154" id="srcline154">154</a></span><span class="line">            <span class="mxinfo " id="T1:U604"><span class="mxinfo " id="T1:U605"><span class="var type1" id="S41T40U817">Phv</span>(<span class="mxinfo " id="T8:U607">3</span>)</span> = <span class="mxinfo " id="T1:U608"><span class="mxinfo " id="T1:U609"><span class="var type1" id="S12T9U821">pL</span>(<span class="mxinfo " id="T1:U611"><span class="var type1" id="S26T40U823">i</span>(<span class="mxinfo " id="T8:U613">3</span>)</span>)</span>+<span class="mxinfo " id="T1:U614"><span class="mxinfo " id="T1:U615">(<span class="mxinfo " id="T1:U616"><span class="mxinfo " id="T1:U617">1</span>-<span class="mxinfo " id="T1:U618"><span class="var type1" id="S10T9U831">aL</span>(<span class="mxinfo " id="T1:U620"><span class="var type1" id="S26T40U833">i</span>(<span class="mxinfo " id="T8:U622">3</span>)</span>)</span></span>)*<span class="mxinfo " id="T1:U623">diff(<span class="mxinfo " id="T38:U624"><span class="var type1" id="S12T9U838">pL</span>(<span class="mxinfo " id="T38:U626"><span class="mxinfo " id="T1:U627"><span class="var type1" id="S26T40U841">i</span>(<span class="mxinfo " id="T8:U629">3</span>)</span>:<span class="mxinfo " id="T1:U630"><span class="var type1" id="S26T40U845">i</span>(3)+1</span></span>)</span>)</span></span>/<span class="mxinfo " id="T1:U632">diff(<span class="mxinfo " id="T38:U633"><span class="var type1" id="S10T9U851">aL</span>(<span class="mxinfo " id="T38:U635"><span class="mxinfo " id="T1:U636"><span class="var type1" id="S26T40U854">i</span>(<span class="mxinfo " id="T8:U638">3</span>)</span>:<span class="mxinfo " id="T1:U639"><span class="var type1" id="S26T40U858">i</span>(3)+1</span></span>)</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,155" id="srcline155">155</a></span><span class="line">            <span class="comment">% The phase margin is determine accorringo the one is closet to </span></span></span>
<span class="srcline"><span class="lineno"><a href="129,156" id="srcline156">156</a></span><span class="line">            <span class="comment">% the instability point (-180 degree)</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,157" id="srcline157">157</a></span><span class="line">            [<span class="var type1" id="S46T1U864">TempPm</span>,<span class="var type1" id="S47T1U865">ii</span>]=min(<span class="mxinfo " id="T40:U643">abs(<span class="mxinfo " id="T40:U644"><span class="var type1" id="S41T40U871">Phv</span>+<span class="mxinfo " id="T1:U646">180</span></span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="129,158" id="srcline158">158</a></span><span class="line">            <span class="comment">% Technical correction to enable correct calculation of the </span></span></span>
<span class="srcline"><span class="lineno"><a href="129,159" id="srcline159">159</a></span><span class="line">            <span class="comment">% Phase margin at line 133</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,160" id="srcline160">160</a></span><span class="line">            <span class="mxinfo " id="T1:U647"><span class="var type1" id="S37T1U875">Ph</span> = <span class="mxinfo " id="T1:U649"><span class="mxinfo " id="T1:U650"><span class="var type1" id="S46T1U878">TempPm</span>*<span class="var type1" id="S45T1U879">Stability</span></span>-<span class="mxinfo " id="T1:U653">180</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,161" id="srcline161">161</a></span><span class="line">            <span class="mxinfo " id="T1:U654"><span class="var type1" id="S5T1U883">Wpm</span> = <span class="mxinfo " id="T1:U656"><span class="mxinfo " id="T1:U657"><span class="mxinfo " id="T1:U658">interp1(<span class="mxinfo " id="T38:U659"><span class="var type1" id="S10T9U889">aL</span>(<span class="mxinfo " id="T38:U661"><span class="mxinfo " id="T1:U662"><span class="var type1" id="S26T40U892">i</span>(<span class="var type1" id="S47T1U893">ii</span>)</span>:<span class="mxinfo " id="T1:U665"><span class="mxinfo " id="T1:U666"><span class="var type1" id="S26T40U896">i</span>(<span class="var type1" id="S47T1U897">ii</span>)</span>+1</span></span>)</span>,<span class="mxinfo " id="T38:U669"><span class="var type1" id="S7T9U900">f</span>(<span class="mxinfo " id="T38:U671"><span class="mxinfo " id="T1:U672"><span class="var type1" id="S26T40U903">i</span>(<span class="var type1" id="S47T1U904">ii</span>)</span>:<span class="mxinfo " id="T1:U675"><span class="mxinfo " id="T1:U676"><span class="var type1" id="S26T40U907">i</span>(<span class="var type1" id="S47T1U908">ii</span>)</span>+1</span></span>)</span>,<span class="mxinfo " id="T1:U679">1</span>)</span>*<span class="mxinfo " id="T1:U680">2</span></span>*<span class="mxinfo " id="T1:U681">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,162" id="srcline162">162</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="129,163" id="srcline163">163</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,164" id="srcline164">164</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,165" id="srcline165">165</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,166" id="srcline166">166</a></span><span class="line"><span class="comment">% Fix the phase value, so it will be between -360 and 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,167" id="srcline167">167</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="129,168" id="srcline168">168</a></span><span class="line"><span class="keyword">while</span> <span class="mxinfo " id="T7:U682"><span class="var type1" id="S37T1U916">Ph</span>&gt;<span class="mxinfo " id="T1:U684">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="129,169" id="srcline169">169</a></span><span class="line">    <span class="mxinfo " id="T1:U685"><span class="var type1" id="S37T1U920">Ph</span> = <span class="mxinfo " id="T1:U687"><span class="var type1" id="S37T1U922">Ph</span>-<span class="mxinfo " id="T1:U689">360</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,170" id="srcline170">170</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,171" id="srcline171">171</a></span><span class="line"><span class="keyword">while</span> <span class="mxinfo " id="T7:U690"><span class="var type1" id="S37T1U926">Ph</span>&lt;<span class="mxinfo " id="T1:U692">-<span class="mxinfo " id="T1:U693">360</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="129,172" id="srcline172">172</a></span><span class="line">    <span class="mxinfo " id="T1:U694"><span class="var type1" id="S37T1U931">Ph</span> = <span class="mxinfo " id="T1:U696"><span class="var type1" id="S37T1U933">Ph</span>+<span class="mxinfo " id="T1:U698">360</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,173" id="srcline173">173</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,174" id="srcline174">174</a></span><span class="line"><span class="comment">% The phase margin is the difference between the phase at the 0 dB</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,175" id="srcline175">175</a></span><span class="line"><span class="comment">% crossing and -180 degree.</span></span></span>
<span class="srcline"><span class="lineno"><a href="129,176" id="srcline176">176</a></span><span class="line"><span class="mxinfo " id="T1:U699"><span class="var type1" id="S4T1U937">Pm</span> = <span class="mxinfo " id="T1:U701"><span class="var type1" id="S37T1U939">Ph</span>+<span class="mxinfo " id="T1:U703">180</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="129,177" id="srcline177">177</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="129,178" id="srcline178">178</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
