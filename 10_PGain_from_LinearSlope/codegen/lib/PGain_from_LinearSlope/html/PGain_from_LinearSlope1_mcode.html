<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">StartFrequency</span>, <span class="var type1" id="S3T1U4">EndFrequency</span>, <span class="var type1" id="S4T1U5">SlopeResult</span>, <span class="var type1" id="S5T1U6">NumberOfPoints</span>,<span class="var type1" id="S6T1U7">PlantGain</span>, <span class="var type1" id="S7T1U8">nErrCode</span>] = PGain_from_LinearSlope(<span class="var type1" id="S8T2U11">inf</span>, <span class="var type1" id="S9T2U12">r</span>, <span class="var type1" id="S10T1U13">n</span>, <span class="var type1" id="S11T1U14">MinFreqRange</span>, <span class="var type1" id="S12T1U15">MaxFreqRange</span>, <span class="var type1" id="S13T1U16">Slope</span>, <span class="var type1" id="S14T1U17">Tolerance</span>,<span class="var type1" id="S15T2U18">vPh</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"><span class="comment">% [StartFrequency, EndFrequency, SlopeResult, NumberOfPoints,PlantGain] = PGain_from_LinearSlope(f, r, n, MinFreqRange, MaxFreqRange, Slope, Tolerance)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">%Ver02 - add nErrCode, other bug is fixed at the LinearSlopeRange(Ver06)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="comment">%Ver03 -  df chg to 0.05 from 0.01,otherwise size too large;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">%         MaxMemorySize is chged from 1000 to 1e7;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="comment">%%nErrCode</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="comment">% -1 : input parameter wrong: MinFreqRange or MaxFreqRange outof range;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="comment">% -2 : input parameter (MinFreqRange&gt; MaxFreqRange) conflict;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="comment">% -3: not find any period within the tolorance;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">% -5; calculation fail;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">% -10: calculate failed;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">% -11: freq range is out of middle variable size;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">%to use phase info to limit the slope searching range, any freq whose phase</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="comment">%smaller than -240deg, will be not the linear slope range ,will not be the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="comment">%search range:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">% idxPhLarger180 = find( phdeg &lt;=( -180-60 ));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">% EndIndex = idxPhLarger180(1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="comment">% 8 input:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">% inf, r, n, MinFreqRange, MaxFreqRange, Slope, Tolerance,vPh</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">% 6 output</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">% % StartFrequency, EndFrequency, SlopeResult, NumberOfPoints,PlantGain, nErrCode</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">%%%%%%%%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"><span class="mxinfo " id="T1:U15"><span class="var type1" id="S2T1U21">StartFrequency</span> = <span class="mxinfo " id="T1:U17">0</span></span>;         <span class="comment">% to be ready if we return due to some error</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="mxinfo " id="T1:U18"><span class="var type1" id="S3T1U25">EndFrequency</span> = <span class="mxinfo " id="T1:U20">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="mxinfo " id="T1:U21"><span class="var type1" id="S4T1U29">SlopeResult</span> = <span class="mxinfo " id="T1:U23">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="mxinfo " id="T1:U24"><span class="var type1" id="S5T1U33">NumberOfPoints</span> = <span class="mxinfo " id="T1:U26">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="mxinfo " id="T1:U27"><span class="var type1" id="S6T1U37">PlantGain</span> = <span class="mxinfo " id="T1:U29">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="mxinfo " id="T1:U30"><span class="var type1" id="S7T1U41">nErrCode</span> = <span class="mxinfo " id="T1:U32">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="mxinfo " id="T1:U33"><span class="var type1" id="S16T1U45">MaxMemorySize</span> = <span class="mxinfo " id="T1:U35">1e7</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="mxinfo " id="T3:U36"><span class="var type1" id="S17T3U49">gainLineRange</span> = <span class="mxinfo " id="T3:U38">zeros(<span class="var type1" id="S16T1U52">MaxMemorySize</span>,1)</span></span>;<span class="comment">%%1000 is for the c codegen,since c code will assign other n number of point to other non-zero value, this will affect to the following sum calculation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"><span class="comment">%     %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%input value protection;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">%-------------------------------------------------------------------------%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="mxinfo " id="T4:U40"><span class="var type1" id="S19T4U56">f</span> = <span class="mxinfo " id="T4:U42"><span class="var type1" id="S8T2U58">inf</span>(<span class="mxinfo " id="T5:U44"><span class="mxinfo " id="T1:U45">1</span>:<span class="var type1" id="S10T1U61">n</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T6:U47"><span class="var type1" id="S11T1U65">MinFreqRange</span>&gt; <span class="var type1" id="S12T1U66">MaxFreqRange</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">    <span class="mxinfo " id="T1:U50"><span class="var type1" id="S7T1U69">nErrCode</span> = <span class="mxinfo " id="T1:U52">-<span class="mxinfo " id="T1:U53">2</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T6:U54"><span class="var type1" id="S7T1U75">nErrCode</span>&lt;<span class="mxinfo " id="T1:U56">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line">    <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T6:U57"><span class="var type1" id="S11T1U82">MinFreqRange</span>&lt; <span class="mxinfo " id="T1:U59"><span class="var type1" id="S19T4U84">f</span>(<span class="mxinfo " id="T1:U61">1</span>)</span></span> || <span class="mxinfo " id="T6:U62"><span class="var type1" id="S12T1U87">MaxFreqRange</span> &gt; <span class="mxinfo " id="T1:U64"><span class="var type1" id="S19T4U89">f</span>(<span class="mxinfo " id="T1:U66">end</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line">    <span class="mxinfo " id="T1:U67"><span class="var type1" id="S7T1U94">nErrCode</span> = <span class="mxinfo " id="T1:U69">-<span class="mxinfo " id="T1:U70">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T6:U71"><span class="var type1" id="S7T1U100">nErrCode</span>&lt;<span class="mxinfo " id="T1:U73">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line">    <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="comment">%-------------------------------------------------------------------------%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="comment">% Generate fix resolution response vector (0.1Hz)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="mxinfo " id="T1:U74"><span class="var type1" id="S21T1U105">df</span> = <span class="mxinfo " id="T1:U76">0.05</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"><span class="mxinfo " id="T7:U77"><span class="var type1" id="S22T7U109">fnew</span> = <span class="mxinfo " id="T7:U79"><span class="mxinfo " id="T1:U80"><span class="var type1" id="S19T4U113">f</span>(<span class="mxinfo " id="T1:U82">1</span>)</span>:<span class="var type1" id="S21T1U115">df</span>:<span class="mxinfo " id="T1:U84"><span class="var type1" id="S19T4U117">f</span>(<span class="var type1" id="S10T1U118">n</span>)</span></span></span>;<span class="mxinfo " id="T8:U87"><span class="var type1" id="S22T8U121">fnew</span> = <span class="mxinfo " id="T8:U89"><span class="var type1" id="S22T7U123">fnew</span>(:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line"><span class="comment">% rdb = interp1(f(1:n),r(1:n),fnew);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"><span class="comment">%to solve f is non-unique problem;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line">[<span class="var type1" id="S23T4U128">f_afterUnique</span>, <span class="var type1" id="S24T4U129">index_f_afterUnique</span>] = unique(<span class="var type1" id="S19T4U132">f</span>); <span class="comment">%sort and remove duplicates</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"><span class="mxinfo " id="T4:U94"><span class="var type1" id="S26T4U135">r_afterUnique</span> = <span class="mxinfo " id="T4:U96"><span class="var type1" id="S9T2U137">r</span>(<span class="var type1" id="S24T4U138">index_f_afterUnique</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="mxinfo " id="T1:U99"><span class="var type1" id="S10T1U141">n</span> = <span class="mxinfo " id="T1:U101">length(<span class="var type1" id="S24T4U144">index_f_afterUnique</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="mxinfo " id="T8:U103"><span class="var type1" id="S28T8U147">rdb</span> = <span class="mxinfo " id="T8:U105">interp1(<span class="mxinfo " id="T4:U106"><span class="var type1" id="S23T4U151">f_afterUnique</span>(<span class="mxinfo " id="T5:U108"><span class="mxinfo " id="T1:U109">1</span>:<span class="var type1" id="S10T1U154">n</span></span>)</span>,<span class="mxinfo " id="T4:U111"><span class="var type1" id="S26T4U156">r_afterUnique</span>(<span class="mxinfo " id="T5:U113"><span class="mxinfo " id="T1:U114">1</span>:<span class="var type1" id="S10T1U159">n</span></span>)</span>,<span class="var type1" id="S22T8U160">fnew</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="comment">%EndIndex = length(fnew);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"><span class="comment">%improve @20160728</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="mxinfo " id="T8:U117"><span class="var type1" id="S30T8U163">phdeg</span> = <span class="mxinfo " id="T8:U119">interp1(<span class="mxinfo " id="T4:U120"><span class="var type1" id="S23T4U167">f_afterUnique</span>(<span class="mxinfo " id="T5:U122"><span class="mxinfo " id="T1:U123">1</span>:<span class="var type1" id="S10T1U170">n</span></span>)</span>,<span class="mxinfo " id="T4:U125"><span class="var type1" id="S15T2U172">vPh</span>(<span class="mxinfo " id="T5:U127"><span class="mxinfo " id="T1:U128">1</span>:<span class="var type1" id="S10T1U175">n</span></span>)</span>,<span class="var type1" id="S22T8U176">fnew</span>)</span></span>;<span class="comment">%%improve program,add vPh info</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="comment">%%%not use the ending freq;but use the vPh=-180deg to set the EndIndex;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="mxinfo " id="T8:U131"><span class="var type1" id="S31T8U179">idxPhLarger180</span> = <span class="mxinfo " id="T8:U133">find( <span class="mxinfo " id="T9:U134"><span class="var type1" id="S30T8U183">phdeg</span> &lt;=( <span class="mxinfo " id="T1:U136"><span class="mxinfo " id="T1:U137">-<span class="mxinfo " id="T1:U138">180</span></span>-<span class="mxinfo " id="T1:U139">60</span></span> )</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T6:U140">isempty(<span class="var type1" id="S31T8U193">idxPhLarger180</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line">    <span class="mxinfo " id="T8:U142"><span class="var type1" id="S31T8U196">idxPhLarger180</span> = <span class="mxinfo " id="T8:U144">find( <span class="mxinfo " id="T9:U145"><span class="var type1" id="S30T8U200">phdeg</span> == <span class="mxinfo " id="T1:U147">min(<span class="var type1" id="S30T8U203">phdeg</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="mxinfo " id="T1:U149"><span class="var type1" id="S35T1U206">EndIndex</span> = <span class="mxinfo " id="T1:U151"><span class="var type1" id="S31T8U208">idxPhLarger180</span>(<span class="mxinfo " id="T1:U153">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"><span class="mxinfo " id="T1:U154"><span class="var type1" id="S36T1U212">tol</span> = <span class="mxinfo " id="T1:U156">abs(<span class="mxinfo " id="T1:U157"><span class="var type1" id="S14T1U216">Tolerance</span>*<span class="var type1" id="S13T1U217">Slope</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"><span class="mxinfo " id="T8:U160"><span class="var type1" id="S38T8U220">log10f</span> = <span class="mxinfo " id="T8:U162">log10(<span class="var type1" id="S22T8U223">fnew</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"><span class="mxinfo " id="T1:U164"><span class="var type1" id="S40T1U226">MinIndexRange</span> = <span class="mxinfo " id="T1:U166">fix(<span class="mxinfo " id="T1:U167"><span class="var type1" id="S11T1U230">MinFreqRange</span>/<span class="var type1" id="S21T1U231">df</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"><span class="mxinfo " id="T1:U170"><span class="var type1" id="S42T1U234">MaxIndexRange</span> = <span class="mxinfo " id="T1:U172">fix(<span class="mxinfo " id="T1:U173"><span class="var type1" id="S12T1U238">MaxFreqRange</span>/<span class="var type1" id="S21T1U239">df</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="comment">% Must be at least the minimal number of elements.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T6:U176"><span class="var type1" id="S11T1U243">MinFreqRange</span> &gt; (<span class="mxinfo " id="T1:U178"><span class="mxinfo " id="T1:U179"><span class="var type1" id="S19T4U247">f</span>(<span class="var type1" id="S10T1U248">n</span>)</span>-<span class="mxinfo " id="T1:U182"><span class="var type1" id="S19T4U250">f</span>(<span class="mxinfo " id="T1:U184">1</span>)</span></span>)</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">    <span class="mxinfo " id="T1:U185"><span class="var type1" id="S7T1U254">nErrCode</span> = <span class="mxinfo " id="T1:U187">-<span class="mxinfo " id="T1:U188">5</span></span></span>; <span class="comment">%%???</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">    <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line"><span class="mxinfo " id="T8:U189"><span class="var type1" id="S43T8U260">y</span> = <span class="mxinfo " id="T8:U191">zeros(<span class="var type1" id="S35T1U263">EndIndex</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line"><span class="comment">% Claculate the slopes of all the gain responses in MinIndexRange window</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"><span class="comment">% and put the results in y vector.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S44T1U267">k</span>=<span class="mxinfo " id="T1:U194">1</span>:<span class="var type1" id="S35T1U271">EndIndex</span>-<span class="var type1" id="S40T1U272">MinIndexRange</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">    <span class="mxinfo " id="T10:U197"><span class="var type1" id="S45T10U275">H</span> = <span class="mxinfo " id="T10:U199">[<span class="mxinfo " id="T8:U200"><span class="var type1" id="S38T8U279">log10f</span>(<span class="mxinfo " id="T7:U202"><span class="var type1" id="S44T1U281">k</span>:<span class="mxinfo " id="T1:U204"><span class="mxinfo " id="T1:U205"><span class="var type1" id="S44T1U284">k</span>+<span class="var type1" id="S40T1U285">MinIndexRange</span></span>-<span class="mxinfo " id="T1:U208">1</span></span></span>)</span> <span class="mxinfo " id="T8:U209">ones(<span class="var type1" id="S40T1U289">MinIndexRange</span>,1)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">    <span class="mxinfo " id="T11:U211"><span class="var type1" id="S47T11U293">x</span> = <span class="mxinfo " id="T11:U213"><span class="var type1" id="S45T10U295">H</span>\<span class="mxinfo " id="T8:U215"><span class="var type1" id="S28T8U297">rdb</span>(<span class="mxinfo " id="T7:U217"><span class="var type1" id="S44T1U299">k</span>:<span class="mxinfo " id="T1:U219"><span class="mxinfo " id="T1:U220"><span class="var type1" id="S44T1U302">k</span>+<span class="var type1" id="S40T1U303">MinIndexRange</span></span>-<span class="mxinfo " id="T1:U223">1</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">    <span class="mxinfo " id="T1:U224"><span class="mxinfo " id="T1:U225"><span class="var type1" id="S43T8U308">y</span>(<span class="var type1" id="S44T1U309">k</span>)</span> = <span class="mxinfo " id="T1:U228"><span class="var type1" id="S47T11U311">x</span>(<span class="mxinfo " id="T1:U230">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line"><span class="comment">% Calculate the longest series of successive</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line"><span class="comment">% indexes where the slope meets the required</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line"><span class="comment">% accuracy.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line"><span class="comment">% i2mean is index into the mean value of these</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line"><span class="comment">% series</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line"><span class="comment">% kk - contains the indexes of all the slopes that meet the required</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line"><span class="comment">% accuracy</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line"><span class="mxinfo " id="T8:U231"><span class="var type1" id="S48T8U315">kk</span> = <span class="mxinfo " id="T8:U233">find(<span class="mxinfo " id="T9:U234"><span class="mxinfo " id="T8:U235">abs(<span class="mxinfo " id="T8:U236"><span class="var type1" id="S43T8U322">y</span>-<span class="var type1" id="S13T1U323">Slope</span></span>)</span>&lt;<span class="var type1" id="S36T1U324">tol</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line"><span class="mxinfo " id="T8:U240"><span class="var type1" id="S48T8U327">kk</span> = <span class="mxinfo " id="T8:U242"><span class="var type1" id="S48T8U329">kk</span>(<span class="mxinfo " id="T9:U244"><span class="mxinfo " id="T8:U245">diff(<span class="var type1" id="S48T8U333">kk</span>)</span>==<span class="mxinfo " id="T1:U247">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T6:U248">isempty(<span class="var type1" id="S48T8U339">kk</span>)</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">    <span class="mxinfo " id="T1:U250"><span class="var type1" id="S7T1U342">nErrCode</span> = <span class="mxinfo " id="T1:U252">-<span class="mxinfo " id="T1:U253">3</span></span></span>; <span class="comment">%%tolerance too tighten,pls increase tolerance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">    <span class="keyword">return</span>;             <span class="comment">% None found, error</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="comment">% jj - is set of indexes of kk. kk(jj(1)), kk(jj(2), <span class="keyword">...</span><span class="comment">, kk(jj(N)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="comment">% are the indexes that point to the starting and the ending of sequence of kk.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="mxinfo " id="T8:U254"><span class="var type1" id="S50T8U348">jj</span>=<span class="mxinfo " id="T8:U256">find(<span class="mxinfo " id="T9:U257"><span class="mxinfo " id="T8:U258">diff(<span class="var type1" id="S48T8U354">kk</span>)</span>~=<span class="mxinfo " id="T1:U260">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="comment">%%modify @20160728</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T6:U261">isempty(<span class="var type1" id="S50T8U360">jj</span>)</span>, <span class="comment">%means only one stage inside of the tolorance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">    <span class="mxinfo " id="T1:U263"><span class="var type1" id="S2T1U363">StartFrequency</span> = <span class="mxinfo " id="T1:U265"><span class="var type1" id="S22T8U365">fnew</span>(<span class="mxinfo " id="T1:U267"><span class="var type1" id="S48T8U367">kk</span>(<span class="mxinfo " id="T1:U269">1</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">    <span class="mxinfo " id="T1:U270"><span class="var type1" id="S3T1U371">EndFrequency</span> = <span class="mxinfo " id="T1:U272"><span class="var type1" id="S22T8U373">fnew</span>(<span class="mxinfo " id="T1:U274"><span class="var type1" id="S48T8U375">kk</span>(<span class="mxinfo " id="T1:U276">end</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">    <span class="mxinfo " id="T1:U277"><span class="var type1" id="S4T1U380">SlopeResult</span> = <span class="mxinfo " id="T1:U279">mean(<span class="mxinfo " id="T8:U280"><span class="var type1" id="S43T8U384">y</span>(<span class="mxinfo " id="T8:U282"><span class="var type1" id="S48T8U386">kk</span>(<span class="mxinfo " id="T7:U284"><span class="mxinfo " id="T1:U285">1</span>:end</span>)</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">    <span class="mxinfo " id="T1:U286"><span class="var type1" id="S5T1U393">NumberOfPoints</span> = <span class="mxinfo " id="T1:U288">length(<span class="var type1" id="S48T8U396">kk</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">    <span class="mxinfo " id="T1:U290"><span class="var type1" id="S7T1U399">nErrCode</span> =<span class="mxinfo " id="T1:U292">0</span></span>; <span class="comment">%means success;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">    <span class="comment">%%if return here,calculate the plantGain;!!!!!</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S52T1U403">ii</span>=<span class="mxinfo " id="T1:U294">1</span>:length(<span class="mxinfo " id="T6:U295"><span class="var type1" id="S48T8U409">kk</span>(<span class="mxinfo " id="T7:U297"><span class="mxinfo " id="T1:U298">1</span>:end</span>)</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">        <span class="mxinfo " id="T1:U299"><span class="mxinfo " id="T1:U300"><span class="var type1" id="S17T3U417">gainLineRange</span>(<span class="var type1" id="S52T1U418">ii</span>)</span> = <span class="mxinfo " id="T1:U303"><span class="mxinfo " id="T1:U304"><span class="mxinfo " id="T1:U305"><span class="mxinfo " id="T1:U306"><span class="mxinfo " id="T1:U307"><span class="mxinfo " id="T1:U308"><span class="mxinfo " id="T1:U309">abs(<span class="mxinfo " id="T1:U310"><span class="mxinfo " id="T1:U311">10</span>.^(<span class="mxinfo " id="T1:U312"><span class="mxinfo " id="T1:U313"><span class="var type1" id="S28T8U432">rdb</span>(<span class="mxinfo " id="T1:U315"><span class="var type1" id="S48T8U434">kk</span>(<span class="var type1" id="S52T1U435">ii</span>)</span>)</span>/<span class="mxinfo " id="T1:U318">20</span></span>)</span>)</span>*<span class="mxinfo " id="T1:U319"><span class="var type1" id="S22T8U438">fnew</span>(<span class="mxinfo " id="T1:U321"><span class="var type1" id="S48T8U440">kk</span>(<span class="var type1" id="S52T1U441">ii</span>)</span>)</span></span>*<span class="mxinfo " id="T1:U324">2</span></span>*<span class="mxinfo " id="T1:U325">pi</span></span>*<span class="mxinfo " id="T1:U326"><span class="var type1" id="S22T8U446">fnew</span>(<span class="mxinfo " id="T1:U328"><span class="var type1" id="S48T8U448">kk</span>(<span class="var type1" id="S52T1U449">ii</span>)</span>)</span></span>*<span class="mxinfo " id="T1:U331">2</span></span>*<span class="mxinfo " id="T1:U332">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">    <span class="mxinfo " id="T1:U333"><span class="var type1" id="S6T1U455">PlantGain</span>  = <span class="mxinfo " id="T1:U335"><span class="mxinfo " id="T1:U336">sum(<span class="var type1" id="S17T3U459">gainLineRange</span>)</span>/<span class="mxinfo " id="T1:U338">length(<span class="var type1" id="S48T8U462">kk</span>)</span></span></span>; <span class="comment">%%can not use mean of matlab for the zero value</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">    <span class="mxinfo " id="T1:U340"><span class="var type1" id="S6T1U465">PlantGain</span> = <span class="var type1" id="S6T1U467">PlantGain</span>(1)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">    <span class="comment">%%%finish cal plant gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">    <span class="keyword">return</span>;             <span class="comment">% No need continue,following to find the best one during many stages;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line"><span class="mxinfo " id="T8:U343"><span class="var type1" id="S50T8U472">jj</span> = <span class="mxinfo " id="T8:U345">[<span class="mxinfo " id="T1:U346">1</span>;<span class="var type1" id="S50T8U477">jj</span>;<span class="mxinfo " id="T8:U348"><span class="var type1" id="S50T8U480">jj</span>+<span class="mxinfo " id="T1:U350">1</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line"><span class="mxinfo " id="T8:U351"><span class="var type1" id="S50T8U484">jj</span> = <span class="mxinfo " id="T8:U353">sort(<span class="var type1" id="S50T8U487">jj</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line"><span class="mxinfo " id="T8:U355"><span class="var type1" id="S50T8U491">jj</span>(<span class="mxinfo " id="T1:U357">end</span>) = []</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line"><span class="comment">% ii - is an index of jj. kk(jj(ii)) is the index to starting point of the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line"><span class="comment">% longest sequence.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line"><span class="comment">% Note that we are looking for the longest sequence from the point of view</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line"><span class="comment">% of a user looking at the Bode graph. This means, when the X axis is</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line"><span class="comment">% logarithmic.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line"><span class="comment">% As a result, we use the "/" (division) of end and start frequencies of</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line"><span class="comment">% each range (and not "-").</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">[<span class="mxinfo " id="T1:U358">~</span>,<span class="var type1" id="S52T1U500">ii</span>]=max(<span class="mxinfo " id="T8:U360"><span class="mxinfo " id="T8:U361"><span class="var type1" id="S48T8U505">kk</span>(<span class="mxinfo " id="T8:U363"><span class="var type1" id="S50T8U507">jj</span>(<span class="mxinfo " id="T7:U365"><span class="mxinfo " id="T1:U366">2</span>:<span class="mxinfo " id="T1:U367">2</span>:end</span>)</span>)</span>./<span class="mxinfo " id="T8:U368"><span class="var type1" id="S48T8U515">kk</span>(<span class="mxinfo " id="T8:U370"><span class="var type1" id="S50T8U517">jj</span>(<span class="mxinfo " id="T7:U372"><span class="mxinfo " id="T1:U373">1</span>:<span class="mxinfo " id="T1:U374">2</span>:<span class="mxinfo " id="T1:U375"><span class="mxinfo " id="T1:U376">end</span>-<span class="mxinfo " id="T1:U377">1</span></span></span>)</span>)</span></span>);<span class="comment">%%bug:if the tolorance too small,the ii maybe empty</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line"><span class="mxinfo " id="T1:U378"><span class="var type1" id="S57T1U528">i2mean</span> = <span class="mxinfo " id="T1:U380">round(<span class="mxinfo " id="T1:U381">sqrt(<span class="mxinfo " id="T1:U382"><span class="mxinfo " id="T1:U383"><span class="var type1" id="S48T8U535">kk</span>(<span class="mxinfo " id="T1:U385"><span class="var type1" id="S50T8U537">jj</span>(<span class="mxinfo " id="T1:U387"><span class="var type1" id="S52T1U539">ii</span>+<span class="mxinfo " id="T1:U389">1</span></span>)</span>)</span>*<span class="mxinfo " id="T1:U390"><span class="var type1" id="S48T8U542">kk</span>(<span class="mxinfo " id="T1:U392"><span class="var type1" id="S50T8U544">jj</span>(<span class="var type1" id="S52T1U545">ii</span>)</span>)</span></span>)</span>)</span></span>;   <span class="comment">% Geometrical mean</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line"><span class="comment">% Calculate the permmited range that the min range can be extended to</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line"><span class="mxinfo " id="T12:U395"><span class="var type1" id="S60T12U548">l</span> = <span class="mxinfo " id="T12:U397">zeros(<span class="mxinfo " id="T1:U398">3</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line"><span class="mxinfo " id="T1:U399"><span class="mxinfo " id="T1:U400"><span class="var type1" id="S60T12U556">l</span>(<span class="mxinfo " id="T13:U402">1</span>)</span> = <span class="mxinfo " id="T1:U403"><span class="mxinfo " id="T1:U404"><span class="mxinfo " id="T1:U405">2</span>*(<span class="mxinfo " id="T1:U406"><span class="var type1" id="S57T1U563">i2mean</span>-<span class="mxinfo " id="T1:U408">1</span></span>)</span>+<span class="var type1" id="S40T1U565">MinIndexRange</span></span></span>;                                            <span class="comment">% limitation by the first index of the vectors.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line"><span class="mxinfo " id="T1:U410"><span class="mxinfo " id="T1:U411"><span class="var type1" id="S60T12U569">l</span>(<span class="mxinfo " id="T13:U413">2</span>)</span> = <span class="mxinfo " id="T1:U414"><span class="mxinfo " id="T1:U415"><span class="mxinfo " id="T1:U416">2</span>*(<span class="mxinfo " id="T1:U417"><span class="var type1" id="S35T1U576">EndIndex</span> - (<span class="mxinfo " id="T1:U419">(<span class="mxinfo " id="T1:U420"><span class="var type1" id="S57T1U581">i2mean</span>-<span class="mxinfo " id="T1:U422">1</span></span>)+<span class="var type1" id="S40T1U583">MinIndexRange</span></span>)</span>)</span>+<span class="var type1" id="S40T1U584">MinIndexRange</span></span></span>;      <span class="comment">% limitation by the last index of the vectors.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line"><span class="mxinfo " id="T1:U425"><span class="mxinfo " id="T1:U426"><span class="var type1" id="S60T12U588">l</span>(<span class="mxinfo " id="T13:U428">3</span>)</span> = <span class="var type1" id="S42T1U590">MaxIndexRange</span></span>;                                                               <span class="comment">% limitation as set by the user.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line"><span class="mxinfo " id="T1:U430"><span class="var type1" id="S61T1U593">min_l</span> = <span class="mxinfo " id="T1:U432">min(<span class="var type1" id="S60T12U596">l</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line"><span class="comment">% Claculate the slopes of all gain responses around the optimal point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line"><span class="comment">% and put the results in z vector.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line"><span class="mxinfo " id="T8:U434"><span class="var type1" id="S62T8U599">z</span> = <span class="mxinfo " id="T8:U436">zeros(<span class="mxinfo " id="T1:U437">(<span class="mxinfo " id="T1:U438"><span class="var type1" id="S61T1U605">min_l</span>-<span class="var type1" id="S40T1U606">MinIndexRange</span></span>)/<span class="mxinfo " id="T1:U441">2</span></span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S44T1U611">k</span>=<span class="mxinfo " id="T1:U443">1</span>:(<span class="mxinfo " id="T1:U444"><span class="var type1" id="S61T1U617">min_l</span>-<span class="var type1" id="S40T1U618">MinIndexRange</span></span>)/<span class="mxinfo " id="T1:U447">2</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">    <span class="mxinfo " id="T7:U448"><span class="var type1" id="S63T7U622">IndexRange</span>=<span class="mxinfo " id="T7:U450"><span class="mxinfo " id="T1:U451"><span class="var type1" id="S57T1U625">i2mean</span>-<span class="var type1" id="S44T1U626">k</span></span>:<span class="mxinfo " id="T1:U454"><span class="mxinfo " id="T1:U455"><span class="mxinfo " id="T1:U456"><span class="var type1" id="S57T1U630">i2mean</span>+<span class="var type1" id="S40T1U631">MinIndexRange</span></span>+<span class="var type1" id="S44T1U632">k</span></span>-<span class="mxinfo " id="T1:U460">1</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">    <span class="mxinfo " id="T10:U461"><span class="var type1" id="S45T10U636">H</span> = <span class="mxinfo " id="T10:U463">[<span class="mxinfo " id="T8:U464"><span class="var type1" id="S38T8U640">log10f</span>(<span class="var type1" id="S63T7U641">IndexRange</span>)</span> <span class="mxinfo " id="T8:U467">ones(<span class="mxinfo " id="T1:U468">length(<span class="var type1" id="S63T7U646">IndexRange</span>)</span>,1)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">    <span class="mxinfo " id="T11:U470"><span class="var type1" id="S47T11U650">x</span> = <span class="mxinfo " id="T11:U472"><span class="var type1" id="S45T10U652">H</span>\<span class="mxinfo " id="T8:U474"><span class="var type1" id="S28T8U654">rdb</span>(<span class="var type1" id="S63T7U655">IndexRange</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">    <span class="mxinfo " id="T1:U477"><span class="mxinfo " id="T1:U478"><span class="var type1" id="S62T8U659">z</span>(<span class="var type1" id="S44T1U660">k</span>)</span> = <span class="mxinfo " id="T1:U481"><span class="var type1" id="S47T11U662">x</span>(<span class="mxinfo " id="T1:U483">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line"><span class="mxinfo " id="T8:U484"><span class="var type1" id="S64T8U666">zms</span> = <span class="mxinfo " id="T8:U486"><span class="var type1" id="S62T8U668">z</span>-<span class="var type1" id="S13T1U669">Slope</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line"><span class="comment">% Takes the last one, meaning the wider window that still sarisfies the slope demand</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line"><span class="mxinfo " id="T14:U489"><span class="var type1" id="S44T14U672">k</span> = <span class="mxinfo " id="T14:U491">find(<span class="mxinfo " id="T9:U492"><span class="mxinfo " id="T8:U493">abs(<span class="var type1" id="S64T8U678">zms</span>)</span>&lt;<span class="var type1" id="S36T1U679">tol</span></span>,1,<span class="string">'last'</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line"><span class="mxinfo " id="T15:U496"><span class="var type1" id="S65T15U684">flag</span> = (<span class="mxinfo " id="T15:U498"><span class="var type1" id="S44T14U687">k</span>~=<span class="mxinfo " id="T1:U500">0</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line"><span class="comment">% Take the values only if a solution was found</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line"><span class="keyword">if</span> ((<span class="mxinfo " id="T6:U501">~<span class="mxinfo " id="T6:U502">isempty(<span class="var type1" id="S65T15U697">flag</span>)</span></span>) &amp;&amp; <span class="mxinfo " id="T6:U504">all(<span class="var type1" id="S65T15U700">flag</span>)</span>),                 <span class="comment">% all() is required by codegen, checking isempty is required as all([]) = 1, surprisingly</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line">    <span class="mxinfo " id="T14:U506"><span class="var type1" id="S67T14U703">k1</span> = <span class="mxinfo " id="T14:U508"><span class="var type1" id="S57T1U705">i2mean</span>-<span class="var type1" id="S44T14U706">k</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line">    <span class="mxinfo " id="T14:U511"><span class="var type1" id="S68T14U709">k2</span> = <span class="mxinfo " id="T14:U513"><span class="mxinfo " id="T14:U514"><span class="mxinfo " id="T1:U515"><span class="var type1" id="S57T1U713">i2mean</span>+<span class="var type1" id="S40T1U714">MinIndexRange</span></span>+<span class="var type1" id="S44T14U715">k</span></span>-<span class="mxinfo " id="T1:U519">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line">    <span class="mxinfo " id="T14:U520"><span class="var type1" id="S2T14U719">StartFrequency</span> = <span class="mxinfo " id="T14:U522"><span class="var type1" id="S22T8U721">fnew</span>(<span class="var type1" id="S67T14U722">k1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line">    <span class="mxinfo " id="T14:U525"><span class="var type1" id="S3T14U725">EndFrequency</span> = <span class="mxinfo " id="T14:U527"><span class="var type1" id="S22T8U727">fnew</span>(<span class="var type1" id="S68T14U728">k2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line">    <span class="mxinfo " id="T14:U530"><span class="var type1" id="S4T14U731">SlopeResult</span> = <span class="mxinfo " id="T14:U532"><span class="var type1" id="S62T8U733">z</span>(<span class="var type1" id="S44T14U734">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">    <span class="mxinfo " id="T14:U535"><span class="var type1" id="S5T14U737">NumberOfPoints</span> = <span class="mxinfo " id="T14:U537"><span class="mxinfo " id="T14:U538"><span class="var type1" id="S68T14U740">k2</span> - <span class="var type1" id="S67T14U741">k1</span></span> + <span class="mxinfo " id="T1:U541">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">    <span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">    <span class="comment">% We didn't suceed to extend the initial solution, so we return the initial solution</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">    <span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line">    <span class="mxinfo " id="T14:U542"><span class="var type1" id="S2T14U746">StartFrequency</span> = <span class="mxinfo " id="T1:U544"><span class="var type1" id="S22T8U748">fnew</span>(<span class="var type1" id="S57T1U749">i2mean</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line">    <span class="mxinfo " id="T14:U547"><span class="var type1" id="S3T14U752">EndFrequency</span> = <span class="mxinfo " id="T1:U549"><span class="var type1" id="S22T8U754">fnew</span>(<span class="mxinfo " id="T1:U551"><span class="mxinfo " id="T1:U552"><span class="var type1" id="S57T1U757">i2mean</span>+<span class="var type1" id="S40T1U758">MinIndexRange</span></span>-<span class="mxinfo " id="T1:U555">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line">    <span class="mxinfo " id="T14:U556"><span class="var type1" id="S4T14U762">SlopeResult</span> = <span class="mxinfo " id="T1:U558"><span class="var type1" id="S43T8U764">y</span>(<span class="var type1" id="S57T1U765">i2mean</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">    <span class="mxinfo " id="T14:U561"><span class="var type1" id="S5T14U768">NumberOfPoints</span> = <span class="var type1" id="S40T1U769">MinIndexRange</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line"><span class="comment">% Required for codegen to create scalar output parameters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line"><span class="mxinfo " id="T1:U564"><span class="var type1" id="S2T1U772">StartFrequency</span> = <span class="mxinfo " id="T1:U566"><span class="var type1" id="S2T14U774">StartFrequency</span>(<span class="mxinfo " id="T1:U568">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line"><span class="mxinfo " id="T1:U569"><span class="var type1" id="S3T1U778">EndFrequency</span> = <span class="mxinfo " id="T1:U571"><span class="var type1" id="S3T14U780">EndFrequency</span>(<span class="mxinfo " id="T1:U573">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line"><span class="mxinfo " id="T1:U574"><span class="var type1" id="S4T1U784">SlopeResult</span> = <span class="mxinfo " id="T1:U576"><span class="var type1" id="S4T14U786">SlopeResult</span>(<span class="mxinfo " id="T1:U578">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line"><span class="mxinfo " id="T1:U579"><span class="var type1" id="S5T1U790">NumberOfPoints</span> = <span class="mxinfo " id="T1:U581"><span class="var type1" id="S5T14U792">NumberOfPoints</span>(<span class="mxinfo " id="T1:U583">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line"><span class="comment">%%%for  plant gain calculation;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line"><span class="mxinfo " id="T8:U584"><span class="var type1" id="S69T8U796">idxG</span> = <span class="mxinfo " id="T8:U586">find(  <span class="mxinfo " id="T9:U587"><span class="mxinfo " id="T9:U588"><span class="var type1" id="S22T8U801">fnew</span> &gt; <span class="var type1" id="S2T1U802">StartFrequency</span></span> &amp;  <span class="mxinfo " id="T9:U591"><span class="var type1" id="S22T8U804">fnew</span> &lt; <span class="var type1" id="S3T1U805">EndFrequency</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T6:U594">isempty(<span class="var type1" id="S69T8U810">idxG</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line">    <span class="mxinfo " id="T1:U596"><span class="var type1" id="S7T1U813">nErrCode</span> = <span class="mxinfo " id="T1:U598">-<span class="mxinfo " id="T1:U599">10</span></span></span>;<span class="comment">%program inside wrong;calculate failed;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line">    <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T6:U600"><span class="mxinfo " id="T1:U601">length(<span class="var type1" id="S69T8U822">idxG</span>)</span> &gt; <span class="var type1" id="S16T1U823">MaxMemorySize</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line">    <span class="mxinfo " id="T1:U604"><span class="var type1" id="S7T1U826">nErrCode</span> = <span class="mxinfo " id="T1:U606">-<span class="mxinfo " id="T1:U607">11</span></span></span>;<span class="comment">%freq range is out of middle variable size;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line">    <span class="keyword">return</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S52T1U832">ii</span>=<span class="mxinfo " id="T1:U609">1</span>:length(<span class="var type1" id="S69T8U837">idxG</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line">    <span class="mxinfo " id="T1:U611"><span class="mxinfo " id="T1:U612"><span class="var type1" id="S17T3U841">gainLineRange</span>(<span class="var type1" id="S52T1U842">ii</span>)</span> = <span class="mxinfo " id="T1:U615"><span class="mxinfo " id="T1:U616"><span class="mxinfo " id="T1:U617"><span class="mxinfo " id="T1:U618"><span class="mxinfo " id="T1:U619"><span class="mxinfo " id="T1:U620"><span class="mxinfo " id="T1:U621">abs(<span class="mxinfo " id="T1:U622"><span class="mxinfo " id="T1:U623">10</span>.^(<span class="mxinfo " id="T1:U624"><span class="mxinfo " id="T1:U625"><span class="var type1" id="S28T8U856">rdb</span>(<span class="mxinfo " id="T1:U627"><span class="var type1" id="S69T8U858">idxG</span>(<span class="var type1" id="S52T1U859">ii</span>)</span>)</span>/<span class="mxinfo " id="T1:U630">20</span></span>)</span>)</span>*<span class="mxinfo " id="T1:U631"><span class="var type1" id="S22T8U862">fnew</span>(<span class="mxinfo " id="T1:U633"><span class="var type1" id="S69T8U864">idxG</span>(<span class="var type1" id="S52T1U865">ii</span>)</span>)</span></span>*<span class="mxinfo " id="T1:U636">2</span></span>*<span class="mxinfo " id="T1:U637">pi</span></span>*<span class="mxinfo " id="T1:U638"><span class="var type1" id="S22T8U870">fnew</span>(<span class="mxinfo " id="T1:U640"><span class="var type1" id="S69T8U872">idxG</span>(<span class="var type1" id="S52T1U873">ii</span>)</span>)</span></span>*<span class="mxinfo " id="T1:U643">2</span></span>*<span class="mxinfo " id="T1:U644">pi</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line"><span class="mxinfo " id="T1:U645"><span class="var type1" id="S6T1U879">PlantGain</span>  = <span class="mxinfo " id="T1:U647"><span class="mxinfo " id="T1:U648">sum(<span class="var type1" id="S17T3U883">gainLineRange</span>)</span>/<span class="mxinfo " id="T1:U650">length(<span class="var type1" id="S69T8U886">idxG</span>)</span></span></span>; <span class="comment">%%can not use mean of matlab for the zero value</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line"><span class="mxinfo " id="T1:U652"><span class="var type1" id="S6T1U889">PlantGain</span> = <span class="var type1" id="S6T1U891">PlantGain</span>(1)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,212" id="srcline212">212</a></span><span class="line"></span></span>
</pre>
